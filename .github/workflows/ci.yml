name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Build and start services (docker compose)
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
        run: |
          docker compose up -d --build

      - name: Wait for Postgres and services
        run: |
          sudo apt-get update -y
          # install tools
          sudo apt-get install -y netcat-openbsd curl

          # Wait for Postgres to accept connections (use pg_isready inside the container)
          for i in {1..60}; do
            docker compose exec -T db pg_isready -U postgres >/dev/null 2>&1 && echo "Postgres is up" && break
            echo "Waiting for Postgres... ($i)"; sleep 2
          done

          # Wait for HTTP services used by tests to be available (orders, inventory, payments)
          for svc in 8004 8008 8005; do
            for i in {1..60}; do
              if curl -sSf "http://localhost:${svc}/health" >/dev/null 2>&1; then echo "port ${svc} healthy" && break; fi
              # fallback: if /health not present try root
              if curl -sSf "http://localhost:${svc}/" >/dev/null 2>&1; then echo "port ${svc} responding at /" && break; fi
              echo "Waiting for service on port ${svc}... ($i)"; sleep 2
            done
          done

      - name: Run DB seeder
        run: |
          docker compose run --rm db-seed

      - name: Verify DB seed and services
        run: |
          echo "---- products-service (HTTP) ----"
          curl -sS http://localhost:8002/api/products || (echo "products service not responding" && exit 1)

          echo "---- inventory-service item 1 ----"
          curl -sS http://localhost:8008/api/inventory/items/1 || (echo "inventory service not responding or item missing" && exit 1)

          echo "---- DB products table ----"
          # run SQL inside the postgres container to list products
          docker compose exec -T db psql -U postgres -d vag_force_db -c "SELECT id, name, stock FROM products ORDER BY id;" || (echo "psql query failed" && exit 1)

      - name: Install test requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest -q

      - name: Collect service logs
        if: always()
        run: |
          mkdir -p ci-logs
          docker compose logs orders-service > ci-logs/orders-service.log || true
          docker compose logs db > ci-logs/db.log || true
          docker compose logs inventory-service > ci-logs/inventory-service.log || true
          docker compose logs payments-service > ci-logs/payments-service.log || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: ci-logs

      - name: Tear down compose
        if: always()
        run: |
          docker compose down --volumes

